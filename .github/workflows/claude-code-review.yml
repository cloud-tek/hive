name: claude code review
on:
  pull_request:
    types:
    - opened
    - synchronize
    - reopened
permissions:
  contents: read
  pull-requests: write
  id-token: write
jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: "0"
          token: ${{ secrets.CLOUDTEK_AUTOMATION_TOKEN }}

      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.CLAUDE_CODE_ACTION_APP_ID }}
          private-key: ${{ secrets.CLAUDE_CODE_ACTION_PRIVATE_KEY }}

      - name: Fetch Existing Review Comments
        id: fetch-comments
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          echo "Fetching existing review comments for PR #${{ github.event.pull_request.number }}..."

          # Fetch all review comments (inline comments on code)
          gh api "/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments" \
            --jq '[.[] | select(.user.type == "Bot") | {id: .id, path: .path, line: .line, body: .body, user: .user.login}]' \
            > /tmp/existing-comments.json || echo '[]' > /tmp/existing-comments.json

          COMMENT_COUNT=$(jq 'length' /tmp/existing-comments.json)
          echo "Found $COMMENT_COUNT existing bot review comment(s)"

          if [ $COMMENT_COUNT -gt 0 ]; then
            echo "ðŸ“ Existing comments preview:"
            jq -r '.[] | "  - \(.path):\(.line) by \(.user)"' /tmp/existing-comments.json | head -5
          fi

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        continue-on-error: true
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ steps.app-token.outputs.token }}
          track_progress: true
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}
            BASE BRANCH: ${{ github.event.pull_request.base.ref }}

            EXISTING COMMENTS: A list of existing bot review comments is available at /tmp/existing-comments.json
            This file contains inline comments from previous review iterations.
            You MUST check this file and update existing comments instead of creating duplicates.

            /dotnet-code-review

            IMPORTANT: Use the GitHub MCP tools to post inline comments on specific lines.
            For code-specific feedback:
            - Check /tmp/existing-comments.json for existing comments on the same file and line
            - If a comment exists, UPDATE it using the GitHub API PATCH endpoint
            - If no comment exists, CREATE a new one using mcp__github_inline_comment__create_inline_comment

            Do NOT post duplicate comments. Always update existing comments when possible.
          claude_args: |
            --max-turns 25
            --allowedTools "mcp__github,mcp__github__create_issue_comment,mcp__github_inline_comment,mcp__github_inline_comment__create_inline_comment,mcp__github_comment,mcp__github_comment__update_claude_comment,Bash,Read,Grep,Glob,Edit,Write"
            --model claude-sonnet-4-5-20250929
          show_full_output: true

      - name: Check for Critical Issues
        if: always()
        run: |
          if [ ! -f /tmp/review-results.json ]; then
            echo "âš ï¸  Review results file not found - Claude Code may have failed to complete"
            echo "Checking if Claude Code step failed..."
            if [ "${{ steps.claude-review.outcome }}" != "success" ]; then
              echo "âŒ Claude Code review failed to complete"
              exit 1
            fi
            echo "Claude Code completed but no results file generated - assuming LGTM"
            exit 0
          fi

          echo "ðŸ“‹ Review Results:"
          cat /tmp/review-results.json | jq '.'

          CRITICAL=$(jq -r '.has_critical_issues' /tmp/review-results.json)
          HIGH=$(jq -r '.has_high_priority_issues' /tmp/review-results.json)
          CRITICAL_COUNT=$(jq -r '.critical_count' /tmp/review-results.json)
          HIGH_COUNT=$(jq -r '.high_priority_count' /tmp/review-results.json)

          echo ""
          echo "ðŸ“Š Issue Summary:"
          echo "  Critical Issues: $CRITICAL_COUNT"
          echo "  High Priority Issues: $HIGH_COUNT"
          echo ""

          if [ "$CRITICAL" = "true" ]; then
            echo "âŒ BUILD FAILED: Critical issues detected ($CRITICAL_COUNT issue(s))"
            echo "Critical issues must be fixed before merging."
            exit 1
          fi

          if [ "$HIGH" = "true" ]; then
            echo "âŒ BUILD FAILED: High priority issues detected ($HIGH_COUNT issue(s))"
            echo "High priority issues must be addressed before merging."
            exit 1
          fi

          echo "âœ… No critical or high priority issues detected"
          exit 0

      - name: Generate Review Summary Comment
        if: always() && hashFiles('/tmp/review-results.json') != ''
        run: |
          # Generate a markdown summary from the JSON results
          cat > /tmp/review-summary.md << 'EOF'
          ## ðŸ¤– Claude Code Review Summary

          EOF

          # Add summary from JSON if available
          if [ -f /tmp/review-results.json ]; then
            SUMMARY=$(jq -r '.summary // "Review completed"' /tmp/review-results.json)
            CRITICAL_COUNT=$(jq -r '.critical_count // 0' /tmp/review-results.json)
            HIGH_COUNT=$(jq -r '.high_priority_count // 0' /tmp/review-results.json)
            REC_COUNT=$(jq -r '.recommendation_count // 0' /tmp/review-results.json)
            MINOR_COUNT=$(jq -r '.minor_count // 0' /tmp/review-results.json)

            echo "$SUMMARY" >> /tmp/review-summary.md
            echo "" >> /tmp/review-summary.md
            echo "### ðŸ“Š Issue Breakdown" >> /tmp/review-summary.md
            echo "" >> /tmp/review-summary.md
            echo "| Severity | Count |" >> /tmp/review-summary.md
            echo "|----------|-------|" >> /tmp/review-summary.md
            echo "| âŒ Critical | $CRITICAL_COUNT |" >> /tmp/review-summary.md
            echo "| âš ï¸ High Priority | $HIGH_COUNT |" >> /tmp/review-summary.md
            echo "| ðŸ’¡ Recommendations | $REC_COUNT |" >> /tmp/review-summary.md
            echo "| ðŸ“ Minor/Nitpicks | $MINOR_COUNT |" >> /tmp/review-summary.md
            echo "" >> /tmp/review-summary.md

            if [ "$CRITICAL_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 0 ]; then
              echo "**âš ï¸ This PR has blocking issues that must be addressed before merging.**" >> /tmp/review-summary.md
            elif [ "$REC_COUNT" -gt 0 ] || [ "$MINOR_COUNT" -gt 0 ]; then
              echo "**âœ… No blocking issues found. Please review the recommendations above.**" >> /tmp/review-summary.md
            else
              echo "**âœ… LGTM - No issues found!**" >> /tmp/review-summary.md
            fi

            echo "" >> /tmp/review-summary.md
            echo "_Last updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')_" >> /tmp/review-summary.md
          fi

      - name: Post/Update Summary Comment
        if: always() && hashFiles('/tmp/review-summary.md') != ''
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: claude-code-review-summary
          path: /tmp/review-summary.md
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Upload Review Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-review-results-pr-${{ github.event.pull_request.number }}
          path: /tmp/review-results.json
          if-no-files-found: warn
          retention-days: 30
